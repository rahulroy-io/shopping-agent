# This Compose file creates a "development workstation" container.
# You edit files on Windows, and the same files appear inside the container.
services:
  dev:
    # Name of the built image on your machine.
    image: aiml-dev-img

    # Build instructions for the image.
    build:
      # "../../" means repository root, because this file lives in docker/dev.
      context: ../..
      # Dockerfile path from the build context root.
      dockerfile: docker/dev/Dockerfile

    # Friendly static container name so commands are easy to remember.
    container_name: aiml-dev-container

    # If container exits, Docker restarts it automatically unless you stop it manually.
    restart: unless-stopped

    # Keep STDIN/TTY open so interactive shells behave naturally.
    stdin_open: true
    tty: true

    # Main working folder inside container (project root inside mounted "learning" folder).
    working_dir: /workspace/ai-ml-skill/shopping-agent

    volumes:
      # Mount the broader local "learning" folder into container.
      # Left side = Windows host path.
      # Right side = container path.
      - C:/Users/raulr/OneDrive/Works/learning:/workspace

    environment:
      # App can call any OpenAI-compatible endpoint through this base URL.
      # Current default points to host machine port 8000.
      - LLM_BASE_URL=http://host.docker.internal:8000/v1

      # Placeholder API key for local services that require a non-empty key.
      # Replace with real key for remote providers.
      - LLM_API_KEY=dummy

      # Consistent Python runtime behavior.
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1

    extra_hosts:
      # Lets container resolve "host.docker.internal" to your Windows host.
      - "host.docker.internal:host-gateway"

    networks:
      # Attach this service to isolated bridge network declared below.
      - dev-net

    # Startup flow:
    # 1) If pyproject.toml exists, install project in editable mode
    # 2) Print Python version for quick confirmation
    # 3) Sleep forever so container stays available for shell sessions
    command: ["bash", "-lc", "if [ -f pyproject.toml ]; then python -m pip install -e .; else echo 'pyproject.toml not found, skipping editable install'; fi && python -V && sleep infinity"]

networks:
  dev-net:
    # Default isolated local Docker network.
    driver: bridge
